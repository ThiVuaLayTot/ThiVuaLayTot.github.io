---
layout: event
title: Bảng tổng giải Chiến Trường Thí Quân
---

<style>:root {
            --cttq-bg-dark: #0f1419;
            --cttq-bg-card: #1a1f2e;
            --cttq-bg-hover: #1a2332;
            --cttq-border: #2d3748;
            --cttq-text-main: #e2e8f0;
            --cttq-text-sec: #94a3b8;
            --cttq-text-muted: #64748b;
            --cttq-blue: #60a5fa;
            --cttq-blue-hover: #93c5fd;
            --cttq-gold: #fbbf24;
            --cttq-red: #f87171;
        }

        .cttq-months-container {
            display: grid;
            gap: 40px;
        }

        .cttq-month-section {
            background-color: var(--cttq-bg-card);
            border-radius: 8px;
            overflow: hidden;
        }

        .cttq-month-header {
            background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 50%, #1e3a8a 100%);
            padding: 20px 24px;
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cttq-month-header span:last-child {
            font-size: 12px;
            color: #cbd5e1;
        }

        /* TABLE */
        .cttq-table {
            width: 100%;
            border-collapse: collapse;
        }

        .cttq-table thead {
            background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 50%, #1e3a8a 100%);
            color: #fff;
            font-weight: 600;
        }

        .cttq-table thead th {
            padding: 18px 24px;
            text-align: left;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        .cttq-col-rank {
            width: 15%;
            text-align: center;
        }

        .cttq-col-player {
            width: 65%;
        }

        .cttq-col-points {
            width: 20%;
            text-align: right;
            padding-right: 40px;
        }

        .cttq-table tbody {
            background-color: var(--cttq-bg-dark);
        }

        .cttq-table tbody tr {
            border-bottom: 1px solid var(--cttq-border);
            transition: background-color 0.3s ease;
        }

        .cttq-table tbody tr:hover {
            background-color: var(--cttq-bg-hover);
        }

        .cttq-table tbody td {
            padding: 20px 24px;
            font-size: 14px;
        }

        .cttq-rank-cell {
            text-align: center;
            font-weight: 600;
            color: var(--cttq-gold);
            font-size: 15px;
        }

        .cttq-points-cell {
            text-align: right;
            padding-right: 40px;
            font-weight: 700;
            color: var(--cttq-gold);
            font-size: 16px;
        }

        .cttq-player-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .cttq-avatar {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            border: 2px solid #3b82f6;
            flex-shrink: 0;
        }

        .cttq-player-details {
            flex: 1;
            min-width: 0;
        }

        .cttq-player-name {
            margin-bottom: 6px;
        }

        .cttq-player-name a {
            color: var(--primary-sucess);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .cttq-player-name a:hover {
            color: var(--color-light-green);
            text-decoration: underline;
        }

        .cttq-tournaments {
            font-size: 12px;
            color: var(--cttq-text-sec);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .cttq-tournament-link {
            color: var(--cttq-blue);
            text-decoration: none;
            font-size: 11px;
            padding: 2px 6px;
            background-color: rgba(96, 165, 250, 0.1);
            border-radius: 3px;
            transition: all 0.2s;
            display: inline-block;
            white-space: nowrap;
        }

        .cttq-tournament-link:hover {
            color: var(--cttq-blue-hover);
            background-color: rgba(96, 165, 250, 0.2);
            text-decoration: underline;
        }

        /* CARD LAYOUT - MOBILE */
        .cttq-card {
            display: none;
            padding: 16px;
            background: var(--cttq-bg-hover);
            border-bottom: 1px solid var(--cttq-border);
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .cttq-card.show {
            display: block;
        }

        .cttq-card-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .cttq-card-rank {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--cttq-bg-dark);
            border-radius: 4px;
            font-weight: 700;
            color: var(--cttq-gold);
            flex-shrink: 0;
        }

        .cttq-card-info {
            flex: 1;
            min-width: 0;
        }

        .cttq-card-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            border: 2px solid var(--cttq-blue);
            flex-shrink: 0;
            margin-bottom: 8px;
        }

        .cttq-card-name {
            font-weight: 600;
            color: var(--cttq-blue);
            margin-bottom: 4px;
        }

        .cttq-card-name a {
            color: var(--cttq-blue);
            text-decoration: none;
        }

        .cttq-card-name a:hover {
            color: var(--cttq-blue-hover);
        }

        .cttq-card-points {
            font-size: 13px;
            color: var(--cttq-gold);
            font-weight: 700;
        }

        .cttq-card-tournaments {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--cttq-border);
        }

        .cttq-toggle-btn {
            background: none;
            border: none;
            color: var(--cttq-blue);
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .cttq-toggle-btn:hover {
            color: var(--cttq-blue-hover);
        }

        .cttq-tournament-list {
            display: none;
            flex-direction: column;
            gap: 6px;
        }

        .cttq-tournament-list.show {
            display: flex;
        }

        /* SKELETON */
        .cttq-skeleton {
            background: linear-gradient(90deg, #2d3748 0%, #3a4556 50%, #2d3748 100%);
            background-size: 200% 100%;
            animation: cttq-load 1.5s ease-in-out infinite;
        }

        @keyframes cttq-load {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .cttq-skeleton-row {
            padding: 20px 24px;
            border-bottom: 1px solid var(--cttq-border);
        }

        .cttq-skeleton-rank {
            width: 40px;
            height: 20px;
            margin: 0 auto;
            border-radius: 3px;
        }

        .cttq-skeleton-avatar {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .cttq-skeleton-name {
            width: 150px;
            height: 16px;
            margin-bottom: 8px;
            border-radius: 3px;
        }

        .cttq-skeleton-tournaments {
            width: 300px;
            height: 12px;
            border-radius: 3px;
        }

        .cttq-skeleton-points {
            width: 40px;
            height: 20px;
            border-radius: 3px;
        }

        .cttq-footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid var(--cttq-border);
            color: var(--cttq-text-muted);
            font-size: 12px;
        }

        /* RESPONSIVE - 768px */
        @media (max-width: 768px) {
            .cttq-container { padding: 20px 15px; }
            .cttq-title { font-size: 24px; }
            .cttq-subtitle { font-size: 13px; }

            .cttq-table { display: none; }
            .cttq-card { display: block; }

            .cttq-month-header {
                padding: 16px 20px;
                font-size: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .cttq-card { padding: 14px; }
            .cttq-avatar { width: 44px; height: 44px; }
            .cttq-card-name { font-size: 14px; }
            .cttq-card-points { font-size: 13px; }
            .cttq-tournament-link { font-size: 11px; padding: 4px 8px; }
        }

        /* RESPONSIVE - 600px */
        @media (max-width: 600px) {
            .cttq-container { padding: 15px 12px; }
            .cttq-title { font-size: 22px; margin-bottom: 8px; }
            .cttq-subtitle { font-size: 12px; }

            .cttq-card { padding: 12px; margin-bottom: 10px; }
            .cttq-card-rank { width: 38px; height: 38px; font-size: 12px; }
            .cttq-avatar { width: 38px; height: 38px; }
            .cttq-card-name { font-size: 13px; margin-bottom: 3px; }
            .cttq-card-points { font-size: 12px; }
            .cttq-toggle-btn { font-size: 11px; margin-bottom: 6px; }
            .cttq-tournament-link { font-size: 10px; padding: 3px 6px; word-break: break-word; }

            .cttq-month-header { padding: 14px 16px; font-size: 15px; }
            .cttq-footer { font-size: 11px; margin-top: 20px; padding: 15px 0; }
        }

        /* RESPONSIVE - 480px */
        @media (max-width: 480px) {
            .cttq-container { padding: 12px 10px; }
            .cttq-header { margin-bottom: 20px; padding: 12px 0; }
            .cttq-title { font-size: 20px; margin-bottom: 5px; }
            .cttq-subtitle { font-size: 11px; }

            .cttq-card { padding: 10px; margin-bottom: 8px; }
            .cttq-card-rank { width: 36px; height: 36px; font-size: 11px; }
            .cttq-avatar { width: 36px; height: 36px; }
            .cttq-card-name { font-size: 12px; }
            .cttq-card-points { font-size: 11px; }
            .cttq-toggle-btn { font-size: 10px; gap: 4px; margin-bottom: 4px; }
            .cttq-tournament-link { font-size: 9px; padding: 2px 5px; line-height: 1.3; }

            .cttq-card-tournaments { margin-top: 10px; padding-top: 10px; }
            .cttq-month-header { padding: 12px 14px; font-size: 14px; }
            .cttq-months-container { gap: 20px; }
            .cttq-footer { font-size: 10px; margin-top: 15px; padding: 10px 0; }
        }

        /* RESPONSIVE - 360px */
        @media (max-width: 360px) {
            .cttq-container { padding: 10px 8px; }
            .cttq-title { font-size: 18px; }
            .cttq-subtitle { font-size: 10px; }

            .cttq-card { padding: 8px; margin-bottom: 6px; }
            .cttq-card-rank { width: 32px; height: 32px; font-size: 10px; }
            .cttq-avatar { width: 32px; height: 32px; }
            .cttq-card-name { font-size: 11px; }
            .cttq-card-points { font-size: 10px; }
            .cttq-toggle-btn { font-size: 9px; }
            .cttq-tournament-link { font-size: 8px; padding: 2px 4px; }

            .cttq-month-header { padding: 10px 12px; font-size: 13px; }
        }</style>
<h1 align="center">Các kỳ thủ đạt giải <a href="/events/cttq-chien-truong-thi-quan" style="color: lightskyblue">Chiến Trường Thí Quân</a></h1>
<ul class="tab">
    <li><a href="tvlt">Thí Vua Lấy Tốt</a></li>
    <li><a href="cbtt">Cờ Bí Thí Tốt</a></li>
    <li><a href="cttq" class="active">Chiến Trường Thí Quân</a></li>
    <li><a href="dttv">Đấu Trường Thí Vua</a></li>
</ul><br>
<p>Giải được quản lý bởi Admin <a href="/leaders#admin3">M_DinhHoangViet</a>. <a href="/events/cttq-chien-truong-thi-quan">Chi tiết về sự kiện này.</a></p>
<div class="cttq-months-container" id="cttq-months-container"></div>
<i>Nếu có vấn đề thì xin hãy liên hệ <a href="/leaders#admins" target="_top">quản trị viên</a>.</i>
<br><hr>
<script>
const CHESS_COM_BASE = 'https://api.chess.com/pub';
const GIST_MONTHS = 'https://gist.githubusercontent.com/M-DinhHoangViet/0ae047855007aacfc63886f9d60bc03d/raw';
const GIST_TOURNAMENTS = 'https://gist.githubusercontent.com/M-DinhHoangViet/9c53a11fca709a656076bf6de7c118b0/raw';
let MONTHS = [];
const playerCache = new Map();
let activeRequests = 0;
const MAX_CONCURRENT = 10;
async function withRateLimit(fn) {
    while (activeRequests >= MAX_CONCURRENT) {
        await new Promise(r => setTimeout(r, 50));
    }
    activeRequests++;
    try {
        return await fn();
    } finally {
        activeRequests--;
    }
}
async function fetchJSON(url) {
    return withRateLimit(async () => {
        try {
            const response = await fetch(url);
            if (!response.ok) return null;
            return await response.json();
        } catch (error) {
            return null;
        }
    });
}
async function fetchText(url) {
    return withRateLimit(async () => {
        try {
            const response = await fetch(url);
            if (!response.ok) return null;
            return await response.text();
        } catch (error) {
            return null;
        }
    });
}
async function getCTTQMonths() {
    const text = await fetchText(`${GIST_MONTHS}/cttq.txt`);
    return text ? text.split('\n').filter(line => line.trim()) : [];
}
async function getCTTQTournamentIds(monthId) {
    const text = await fetchText(`${GIST_TOURNAMENTS}/${monthId}.txt`);
    return text ? text.split('\n').filter(line => line.trim()) : [];
}
async function fetchPlayerData(username) {
    if (playerCache.has(username)) {
        return playerCache.get(username);
    }
    const data = await fetchJSON(`${CHESS_COM_BASE}/player/${username}`);
    playerCache.set(username, data);
    return data;
}
function parsePlayerData(playerData) {
    if (!playerData) {
        return { 
            username: 'unknown', 
            avatar: 'https://chess.com/bundles/web/images/user-image.007dad08.svg' 
        };
    }
    const p = playerData.player || playerData;
    return {
        username: p?.username || 'unknown',
        avatar: p?.avatar || 'https://chess.com/bundles/web/images/user-image.007dad08.svg',
        status: p?.status || 'N/A'
    };
}
async function getTournamentTopPlayers(tourId) {
    const roundData = await fetchJSON(`${CHESS_COM_BASE}/tournament/${tourId}/1`);
    if (!roundData?.players) return { players: [], points: [] };
    const players = [];
    const points = [];
    for (const p of roundData.players) {
        if (p.username) {
            players.push(p.username);
            points.push(p.points || 0);
        }
    }
    return { players, points };
}
async function aggregateMonthlyScores(monthId) {
    const tourIds = await getCTTQTournamentIds(monthId);
    if (tourIds.length === 0) return { playerScores: {}, tournaments: [] };
    const playerScores = {};
    const tournaments = [];
    const tourDataPromises = tourIds.map(id => fetchJSON(`${CHESS_COM_BASE}/tournament/${id}`));
    const tourDataList = await Promise.all(tourDataPromises);
    const topPlayersPromises = tourIds.map(id => getTournamentTopPlayers(id));
    const topPlayersList = await Promise.all(topPlayersPromises);
    for (let i = 0; i < tourIds.length; i++) {
        const tournamentData = tourDataList[i];
        const { players, points } = topPlayersList[i];
        if (players.length > 0 && tournamentData) {
            tournaments.push({
                id: tourIds[i],
                name: tournamentData.name || 'Unknown',
                url: tournamentData.url || `https://chess.com/tournament/${tourIds[i]}`,
                topPlayers: players.map((p, j) => ({
                    username: p,
                    points: points[j]
                }))
            });
            for (let j = 0; j < players.length; j++) {
                const username = players[j].toLowerCase();
                if (!playerScores[username]) {
                    playerScores[username] = {
                        username: players[j],
                        totalPoints: 0
                    };
                }
                playerScores[username].totalPoints += points[j];
            }
        }
    }
    return { playerScores, tournaments };
}
async function getMonthlyTop6(monthId) {
    const { playerScores, tournaments } = await aggregateMonthlyScores(monthId);
    const sortedPlayers = Object.values(playerScores)
        .sort((a, b) => b.totalPoints - a.totalPoints)
        .slice(0, 6);
    const top6DataPromises = sortedPlayers.map(p => fetchPlayerData(p.username));
    const top6DataList = await Promise.all(top6DataPromises);
    const cheaters = [];
    const cheatersSet = new Set();
    for (let i = 0; i < sortedPlayers.length; i++) {
        const playerData = top6DataList[i];
        if (playerData) {
            const p = playerData.player || playerData;
            if (p?.status && p.status.includes('closed')) {
                const key = sortedPlayers[i].username.toLowerCase();
                if (!cheatersSet.has(key)) {
                    cheatersSet.add(key);
                    cheaters.push({
                        username: sortedPlayers[i].username,
                        avatar: p.avatar || 'https://www.chess.com/bundles/web/images/user-image.007dad08.svg'
                    });
                }
            }
        }
    }
    return { 
        topPlayers: sortedPlayers, 
        tournaments,
        totalPlayers: Object.keys(playerScores).length,
        cheaters: cheaters,
        top6Data: top6DataList
    };
}
function getPlayerTournamentsInMonth(username, tournaments) {
    const usernameLower = username.toLowerCase();
    const playerTournaments = [];
    for (const tournament of tournaments) {
        for (const topPlayer of tournament.topPlayers || []) {
            if (topPlayer.username.toLowerCase() === usernameLower) {
                playerTournaments.push({
                    name: tournament.name,
                    url: tournament.url,
                    points: topPlayer.points
                });
                break;
            }
        }
    }
    return playerTournaments;
}
function renderCardsLayout(monthId, topPlayers, tournaments, cheaters, top6Data) {
    const html = topPlayers.map((player, i) => {
        const parsed = parsePlayerData(top6Data[i]);
        const cheaterUsernames = new Set(cheaters.map(c => c.username.toLowerCase()));
        const isCheater = cheaterUsernames.has(player.username.toLowerCase());
        const cheaterIcon = isCheater ? ' <i class="fa fa-warning" style="color: #f87171;" title="Tài khoản bị khóa"></i>' : '';
        const playerTournaments = getPlayerTournamentsInMonth(player.username, tournaments);
        const tournamentLinksHTML = playerTournaments.length > 0
            ? playerTournaments.map(t => `<a href="${t.url}" target="_blank" class="cttq-tournament-link">${t.name} (${t.points})</a>`).join('')
            : '<span style="color: #64748b; font-size: 11px;">Không có dữ liệu</span>';
        return `
            <div class="cttq-card">
                <div class="cttq-card-header">
                    <div class="cttq-card-rank">Top ${i + 1}</div>
                    <div style="flex: 1; display: flex; gap: 10px; align-items: flex-start; min-width: 0;">
                        <img class="cttq-avatar" src="${parsed.avatar}" alt="${parsed.username}" onerror="this.src='https://www.chess.com/bundles/web/images/user-image.007dad08.svg'" style="flex-shrink: 0; margin-top: 2px;">
                        <div class="cttq-card-info" style="min-width: 0;">
                            <div class="cttq-card-name">
                                <a href="//chess.com/member/${parsed.username}" target="_blank" style="color: #60a5fa; text-decoration: none; word-break: break-word;">${parsed.username}${cheaterIcon}</a>
                            </div>
                            <div class="cttq-card-points">${player.totalPoints} điểm</div>
                        </div>
                    </div>
                </div>
                <div class="cttq-card-tournaments">
                    <button class="cttq-toggle-btn" onclick="const list = this.nextElementSibling; list.classList.toggle('show'); this.innerHTML = list.classList.contains('show') ? '<i class=\"fa fa-chevron-down\"></i> Ẩn' : '<i class=\"fa fa-chevron-right\"></i> Xem (' + ${playerTournaments.length} + ')';">
                        <i class="fa fa-chevron-right"></i> Xem (${playerTournaments.length})
                    </button>
                    <div class="cttq-tournament-list">
                        ${tournamentLinksHTML}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    return html;
}
function createSkeleton() {
    return `
        <tr class="cttq-skeleton cttq-skeleton-row">
            <td><div class="cttq-skeleton cttq-skeleton-rank"></div></td>
            <td><div style="display: flex; gap: 16px;"><div class="cttq-skeleton cttq-skeleton-avatar"></div><div style="flex: 1;"><div class="cttq-skeleton cttq-skeleton-name"></div><div class="cttq-skeleton cttq-skeleton-tournaments"></div></div></div></td>
            <td><div class="cttq-skeleton cttq-skeleton-points"></div></td>
        </tr>
    `;
}
async function renderMonthTable(monthId) {
    const container = document.getElementById('cttq-months-container');
    const section = document.createElement('div');
    section.className = 'cttq-month-section';
    section.id = `cttq-month-${monthId}`;
    section.innerHTML = `
        <div class="cttq-month-header">
            <span><i class="fa fa-calendar"></i> Tháng ${monthId}</span>
            <span id="cttq-stats-${monthId}" style="font-size: 12px; color: #cbd5e1;">Đang tải...</span>
        </div>
        <table class="cttq-table">
            <thead><tr><th class="cttq-col-rank">THỨ HẠNG</th><th class="cttq-col-player">KỲ THỦ</th><th class="cttq-col-points">TỔNG ĐIỂM</th></tr></thead>
            <tbody id="cttq-tbody-${monthId}">${createSkeleton().repeat(6)}</tbody>
        </table>
        <div id="cttq-cards-${monthId}" style="padding: 0 12px;"></div>
    `;    
    container.appendChild(section);
    try {
        const { topPlayers, tournaments, totalPlayers, cheaters, top6Data } = await getMonthlyTop6(monthId);
        document.getElementById(`cttq-stats-${monthId}`).innerHTML = `<i class="fa fa-users"></i> ${totalPlayers} người | <i class="fa fa-trophy"></i> ${tournaments.length} giải`;
        // Render table layout
        const cheaterUsernames = new Set(cheaters.map(c => c.username.toLowerCase()));
        let tableHtml = '';
        if (topPlayers.length === 0) {
            tableHtml = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #999;">Không có dữ liệu</td></tr>';
        } else {
            for (let i = 0; i < topPlayers.length; i++) {
                const player = topPlayers[i];
                const parsed = parsePlayerData(top6Data[i]);
                const isCheater = cheaterUsernames.has(player.username.toLowerCase());
                const cheaterIcon = isCheater ? ' <i class="fa fa-warning" style="color: #f87171;" title="Tài khoản bị khóa"></i>' : '';
                const playerTournaments = getPlayerTournamentsInMonth(player.username, tournaments);
                const tournamentLinksHTML = playerTournaments.length > 0
                    ? playerTournaments.map(t => `<a href="${t.url}" target="_blank" class="cttq-tournament-link">${t.name} (${t.points} điểm)</a>`).join('')
                    : '<span style="color: #64748b;">Không có dữ liệu</span>';
                tableHtml += `<tr>
                    <td class="cttq-rank-cell">Top ${i + 1}</td>
                    <td style="padding: 16px 24px;">
                        <div class="cttq-player-row">
                            <img class="cttq-avatar" src="${parsed.avatar}" alt="${parsed.username}" height="40" width="40" onerror="this.src='https://www.chess.com/bundles/web/images/user-image.007dad08.svg'">
                            <div class="cttq-player-details">
                                <div class="cttq-player-name"><a href="//chess.com/member/${parsed.username}" target="_blank"><span>${parsed.username}</span>${cheaterIcon}</a></div>
                                <div class="cttq-tournaments">${tournamentLinksHTML}</div>
                            </div>
                        </div>
                    </td>
                    <td class="cttq-points-cell">${player.totalPoints}</td>
                </tr>`;
            }
        }    
        document.getElementById(`cttq-tbody-${monthId}`).innerHTML = tableHtml;
        // Render card layout
        const cardsHtml = renderCardsLayout(monthId, topPlayers, tournaments, cheaters, top6Data);
        document.getElementById(`cttq-cards-${monthId}`).innerHTML = cardsHtml;
    } catch (error) {
        document.getElementById(`cttq-tbody-${monthId}`).innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #f87171;">Lỗi tải dữ liệu</td></tr>';
    }
}
async function initPage() {
    MONTHS = await getCTTQMonths();
    if (MONTHS.length === 0) {
        document.getElementById('cttq-months-container').innerHTML = 
            '<div style="text-align: center; padding: 20px; color: #f87171;">Không tìm thấy dữ liệu tháng</div>';
        return;
    }
    for (const month of MONTHS) {
        await renderMonthTable(month);
    }
}
window.addEventListener('DOMContentLoaded', () => {
    initPage();
});
</script>